{% extends "base.html" %}

{% block title %}ثبت‌نام{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="text-center mb-4">
                    <i class="bi bi-person-plus"></i>
                    ثبت‌نام کاربر جدید
                </h5>

                <style>
                    /* تنظیم فاصله و تاکید روی پیام خطا برای ورودی‌های نام */
                    .name-error {
                        font-size: 0.9rem;
                    }
                </style>

                <form id="registration-form" method="post" novalidate>
                    <div id="registrationSuccess" class="alert alert-success d-none" role="alert">
                        ثبت‌نام با موفقیت انجام شد
                    </div>
                    <div id="registrationError" class="alert alert-danger d-none" role="alert"></div>
                    <div id="nameValidationError" class="alert alert-danger d-none name-error" role="alert">
                        لطفاً نام و نام خانوادگی معتبر وارد کنید.
                    </div>
                    <div id="formatValidationError" class="alert alert-danger d-none name-error" role="alert"></div>
                    <div class="mb-3">
                        <label class="form-label">نام</label>
                        <input
                            type="text"
                            name="first_name"
                            class="form-control"
                            required
                            minlength="2"
                            maxlength="50"
                            value="{{ form_data.first_name if form_data }}"
                        >
                    </div>

                    <div class="mb-3">
                        <label class="form-label">نام خانوادگی</label>
                        <input
                            type="text"
                            name="last_name"
                            class="form-control"
                            required
                            minlength="2"
                            maxlength="50"
                            value="{{ form_data.last_name if form_data }}"
                        >
                    </div>

                    <div class="mb-3">
                        <label class="form-label">شماره دانشجویی</label>
                        <input
                            type="text"
                            name="student_number"
                            class="form-control"
                            required
                            pattern="\\d{9}"
                            inputmode="numeric"
                            value="{{ form_data.student_number if form_data }}"
                        >
                    </div>

                    <div class="mb-3">
                        <label class="form-label">کد ملی</label>
                        <input
                            type="text"
                            name="national_code"
                            class="form-control"
                            required
                            pattern="\\d{10}"
                            inputmode="numeric"
                            value="{{ form_data.national_code if form_data }}"
                        >
                    </div>

                    <div class="mb-3">
                        <label class="form-label">شماره تلفن</label>
                        <input
                            type="text"
                            name="phone_number"
                            class="form-control"
                            required
                            pattern="09\\d{9}"
                            inputmode="numeric"
                            value="{{ form_data.phone_number if form_data }}"
                        >
                    </div>

                    <div class="mb-3">
                        <label class="form-label">جنسیت</label>
                        <select name="gender" class="form-select" required>
                            <option value="">انتخاب کنید</option>
                            <option value="brother" {% if form_data and form_data.gender =="brother" %}selected{% endif %}>برادر</option>
                            <option value="sister" {% if form_data and form_data.gender =="sister" %}selected{% endif %}>خواهر</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">آدرس</label>
                        <textarea name="address" class="form-control" rows="2">{{ form_data.address if form_data }}</textarea>
                    </div>



                    <button class="btn btn-success w-100 mt-3">
                        ثبت‌نام
                    </button>
                </form>

                <div class="text-center mt-3">
                    <a href="/ui-auth/login">حساب دارید؟ وارد شوید</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // اعتبارسنجی ساده برای نام و نام خانوادگی قبل از ارسال فرم
    const form = document.getElementById("registration-form");
    const errorBox = document.getElementById("nameValidationError");
    const successBox = document.getElementById("registrationSuccess");
    const formatErrorBox = document.getElementById("formatValidationError");
    const serverErrorBox = document.getElementById("registrationError");

    form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const firstName = form.querySelector("input[name='first_name']").value.trim();
        const lastName = form.querySelector("input[name='last_name']").value.trim();
        const studentNumber = form.querySelector("input[name='student_number']").value.trim();
        const nationalCode = form.querySelector("input[name='national_code']").value.trim();
        const phoneNumber = form.querySelector("input[name='phone_number']").value.trim();
                const genderValue = form.querySelector("select[name='gender']").value;
        const addressValue = form.querySelector("textarea[name='address']").value.trim();

        errorBox.classList.add("d-none");
        formatErrorBox.classList.add("d-none");
        serverErrorBox.classList.add("d-none");
        successBox.classList.add("d-none");

        if (firstName.length < 2 || lastName.length < 2) {
            errorBox.classList.remove("d-none");
            return;
        }


        if (!/^\d{9}$/.test(studentNumber)) {
            formatErrorBox.textContent = "شماره دانشجویی باید ۹ رقم باشد.";
            formatErrorBox.classList.remove("d-none");
            return;
        }

        if (!/^\d{10}$/.test(nationalCode)) {
            formatErrorBox.textContent = "کد ملی باید ۱۰ رقم باشد.";
            formatErrorBox.classList.remove("d-none");
            return;
        }

        if (!/^09\d{9}$/.test(phoneNumber)) {
            formatErrorBox.textContent = "شماره تماس باید با ۰۹ شروع شده و ۱۱ رقم باشد.";
            formatErrorBox.classList.remove("d-none");
            return;
        }

        if (!genderValue) {
            formatErrorBox.textContent = "لطفاً جنسیت را انتخاب کنید.";
            formatErrorBox.classList.remove("d-none");
            return;
        }


        const payload = {
            first_name: firstName,
            last_name: lastName,
            student_number: studentNumber,
            national_code: nationalCode,
            phone_number: phoneNumber,
            gender: genderValue,
            address: addressValue || null
        };

        try {
            const response = await fetch("/auth/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const data = await response.json();
                if (Array.isArray(data.detail)) {
                    serverErrorBox.textContent = data.detail.map((item) => item.msg).join(" ");
                } else {
                    serverErrorBox.textContent = data.detail || "ثبت‌نام ناموفق بود.";
                }
                serverErrorBox.classList.remove("d-none");
                successBox.classList.add("d-none");
                return;
            }

            serverErrorBox.classList.add("d-none");
            formatErrorBox.classList.add("d-none");
            successBox.classList.remove("d-none");
            form.reset();
        } catch (error) {
            serverErrorBox.textContent = "ارتباط با سرور برقرار نشد.";
            serverErrorBox.classList.remove("d-none");
            successBox.classList.add("d-none");
        }
    });
</script>
{% endblock %}

